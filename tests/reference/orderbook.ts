import { strict as assertStrict } from 'assert';
import { Token } from '@bittrade/assets';
import { KrakenOrderBook, KrakenOrderBookListener, KrakenOrderBookSnapshot, KrakenUpdateMessage, KrakenUpdatePayload } from '../orderbook';
import {cloneDeep} from 'lodash'
import { calculateChecksum, krakenHandleOrderBook, stringifyOrderbook, stringifySingleEntry } from '../websocket';

const SAMPLE_BOOK_SNAPSHOT: KrakenOrderBookSnapshot = [
    416,
    {
        "as": [
            [
                "332.06000",
                "12.04845078",
                "1620209398.055437"
            ],
            [
                "332.11000",
                "22.59824620",
                "1620209391.608055"
            ],
            [
                "332.13000",
                "15.81125585",
                "1620209397.964279"
            ],
            [
                "332.14000",
                "27.06862019",
                "1620209397.637771"
            ],
            [
                "332.22000",
                "22.58624441",
                "1620209390.221912"
            ],
            [
                "332.24000",
                "4.54776660",
                "1620209392.375153"
            ],
            [
                "332.26000",
                "30.13234415",
                "1620209393.746648"
            ],
            [
                "332.27000",
                "3.13701928",
                "1620209398.309052"
            ],
            [
                "332.28000",
                "22.58163073",
                "1620209397.046942"
            ],
            [
                "332.34000",
                "13.00000000",
                "1620209395.958801"
            ],
            [
                "332.37000",
                "22.00100000",
                "1620209393.528951"
            ],
            [
                "332.43000",
                "4.45221540",
                "1620209397.796670"
            ],
            [
                "332.44000",
                "0.24250000",
                "1620209398.200235"
            ],
            [
                "332.47000",
                "254.26030000",
                "1620209396.216759"
            ],
            [
                "332.48000",
                "54.93236058",
                "1620209396.121353"
            ],
            [
                "332.49000",
                "40.00000000",
                "1620209393.524592"
            ],
            [
                "332.52000",
                "7.85582709",
                "1620209398.151178"
            ],
            [
                "332.53000",
                "123.39560000",
                "1620209391.821118"
            ],
            [
                "332.56000",
                "419.74000000",
                "1620209398.208662"
            ],
            [
                "332.67000",
                "3.10261180",
                "1620209398.342636"
            ],
            [
                "332.68000",
                "32.96408291",
                "1620209394.039751"
            ],
            [
                "332.72000",
                "209.76070000",
                "1620209396.358939"
            ],
            [
                "332.81000",
                "26.43040230",
                "1620209397.352421"
            ],
            [
                "332.82000",
                "13.37399921",
                "1620209397.753358"
            ],
            [
                "333.03000",
                "161.02307992",
                "1620209395.328583"
            ]
        ],
        "bs": [
            [
                "332.05000",
                "0.10000004",
                "1620209398.000896"
            ],
            [
                "331.93000",
                "3.79500000",
                "1620209397.868848"
            ],
            [
                "331.86000",
                "15.06083688",
                "1620209397.537775"
            ],
            [
                "331.85000",
                "42.59412581",
                "1620209398.092586"
            ],
            [
                "331.81000",
                "15.81284116",
                "1620209397.639543"
            ],
            [
                "331.78000",
                "22.56148095",
                "1620209378.672652"
            ],
            [
                "331.77000",
                "45.18820751",
                "1620209398.175159"
            ],
            [
                "331.73000",
                "60.00000000",
                "1620209397.593080"
            ],
            [
                "331.72000",
                "18.64475577",
                "1620209393.209003"
            ],
            [
                "331.71000",
                "7.85455545",
                "1620209397.284868"
            ],
            [
                "331.69000",
                "0.24000000",
                "1620209397.040574"
            ],
            [
                "331.68000",
                "22.60271757",
                "1620209397.537063"
            ],
            [
                "331.66000",
                "30.10449556",
                "1620209392.689025"
            ],
            [
                "331.65000",
                "3.13698269",
                "1620209398.165483"
            ],
            [
                "331.64000",
                "6.27012967",
                "1620209397.426005"
            ],
            [
                "331.63000",
                "4.57244860",
                "1620209393.472758"
            ],
            [
                "331.60000",
                "30.34947044",
                "1620209393.801833"
            ],
            [
                "331.58000",
                "109.95794808",
                "1620209397.824771"
            ],
            [
                "331.56000",
                "40.00000000",
                "1620209393.325755"
            ],
            [
                "331.48000",
                "419.28750000",
                "1620209398.208600"
            ],
            [
                "331.45000",
                "23.54278309",
                "1620209397.407166"
            ],
            [
                "331.43000",
                "35.00000000",
                "1620209391.274375"
            ],
            [
                "331.37000",
                "2.96136000",
                "1620209346.500518"
            ],
            [
                "331.31000",
                "22.18270000",
                "1620209391.431762"
            ],
            [
                "331.29000",
                "7.12435597",
                "1620209397.013228"
            ]
        ]
    },
    "book-25",
    "LTC/USD"
]
const SAMPLE_BOOK = SAMPLE_BOOK_SNAPSHOT[1]

export default function(test: Function, assert: typeof assertStrict) {
    test('Initial order book settings', function() {
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true, lastUpdatedTimestamp: 0, coin: Token.RIPPLE, currentReconnectDelay: 100}
        const orderBook: KrakenOrderBookSnapshot = cloneDeep(SAMPLE_BOOK_SNAPSHOT)
        krakenHandleOrderBook(JSON.stringify(orderBook), listener)
        // TODO how do we want to test that?
        // assert.equal(listener.lastUpdatedTimestamp, 20)
        assert.deepEqual(orderBook[1], listener.orderBook)
    })
    test('Remove bid at given price', function() {
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true, lastUpdatedTimestamp: 0, orderBook: cloneDeep(SAMPLE_BOOK), coin: Token.RIPPLE, currentReconnectDelay: 100}
        const message = [544,{"b":[[
            "331.85000",
            "0.00000",
            "1620209398.092586"
        ]],"c":"2060521393"},"book-25","XRP/USD"]
        krakenHandleOrderBook(JSON.stringify(message), listener)
        assert.deepEqual(listener.orderBook!.as, SAMPLE_BOOK.as, 'Asks not supposed to have been modified')
        
        assert.deepEqual(listener.orderBook!.bs, [
            [
                "332.05000",
                "0.10000004",
                "1620209398.000896"
            ],
            [
                "331.93000",
                "3.79500000",
                "1620209397.868848"
            ],
            [
                "331.86000",
                "15.06083688",
                "1620209397.537775"
            ],
            [
                "331.81000",
                "15.81284116",
                "1620209397.639543"
            ],
            [
                "331.78000",
                "22.56148095",
                "1620209378.672652"
            ],
            [
                "331.77000",
                "45.18820751",
                "1620209398.175159"
            ],
            [
                "331.73000",
                "60.00000000",
                "1620209397.593080"
            ],
            [
                "331.72000",
                "18.64475577",
                "1620209393.209003"
            ],
            [
                "331.71000",
                "7.85455545",
                "1620209397.284868"
            ],
            [
                "331.69000",
                "0.24000000",
                "1620209397.040574"
            ],
            [
                "331.68000",
                "22.60271757",
                "1620209397.537063"
            ],
            [
                "331.66000",
                "30.10449556",
                "1620209392.689025"
            ],
            [
                "331.65000",
                "3.13698269",
                "1620209398.165483"
            ],
            [
                "331.64000",
                "6.27012967",
                "1620209397.426005"
            ],
            [
                "331.63000",
                "4.57244860",
                "1620209393.472758"
            ],
            [
                "331.60000",
                "30.34947044",
                "1620209393.801833"
            ],
            [
                "331.58000",
                "109.95794808",
                "1620209397.824771"
            ],
            [
                "331.56000",
                "40.00000000",
                "1620209393.325755"
            ],
            [
                "331.48000",
                "419.28750000",
                "1620209398.208600"
            ],
            [
                "331.45000",
                "23.54278309",
                "1620209397.407166"
            ],
            [
                "331.43000",
                "35.00000000",
                "1620209391.274375"
            ],
            [
                "331.37000",
                "2.96136000",
                "1620209346.500518"
            ],
            [
                "331.31000",
                "22.18270000",
                "1620209391.431762"
            ],
            [
                "331.29000",
                "7.12435597",
                "1620209397.013228"
            ]
        ], 'Expected line for 331.85 to have been removed')
    })
    test('Update existing bid at given price', function() {
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true, lastUpdatedTimestamp: 0, orderBook: cloneDeep(SAMPLE_BOOK), coin: Token.RIPPLE, currentReconnectDelay: 100}
        const message = [544,{"b":[[
            "331.48000",
            "201.00000",
            "this is the new timestamp"
        ]],"c":"2060521393"},"book-25","XRP/USD"]
        krakenHandleOrderBook(JSON.stringify(message), listener)
        assert.deepEqual(listener.orderBook!.as, SAMPLE_BOOK.as, 'Asks not supposed to have been modified')
        
        assert.deepEqual(listener.orderBook!.bs, [
            [
                "332.05000",
                "0.10000004",
                "1620209398.000896"
            ],
            [
                "331.93000",
                "3.79500000",
                "1620209397.868848"
            ],
            [
                "331.86000",
                "15.06083688",
                "1620209397.537775"
            ],
            [
                "331.85000",
                "42.59412581",
                "1620209398.092586"
            ],
            [
                "331.81000",
                "15.81284116",
                "1620209397.639543"
            ],
            [
                "331.78000",
                "22.56148095",
                "1620209378.672652"
            ],
            [
                "331.77000",
                "45.18820751",
                "1620209398.175159"
            ],
            [
                "331.73000",
                "60.00000000",
                "1620209397.593080"
            ],
            [
                "331.72000",
                "18.64475577",
                "1620209393.209003"
            ],
            [
                "331.71000",
                "7.85455545",
                "1620209397.284868"
            ],
            [
                "331.69000",
                "0.24000000",
                "1620209397.040574"
            ],
            [
                "331.68000",
                "22.60271757",
                "1620209397.537063"
            ],
            [
                "331.66000",
                "30.10449556",
                "1620209392.689025"
            ],
            [
                "331.65000",
                "3.13698269",
                "1620209398.165483"
            ],
            [
                "331.64000",
                "6.27012967",
                "1620209397.426005"
            ],
            [
                "331.63000",
                "4.57244860",
                "1620209393.472758"
            ],
            [
                "331.60000",
                "30.34947044",
                "1620209393.801833"
            ],
            [
                "331.58000",
                "109.95794808",
                "1620209397.824771"
            ],
            [
                "331.56000",
                "40.00000000",
                "1620209393.325755"
            ],
            [
                "331.48000",
                "201.00000",
                "this is the new timestamp"
            ],
            [
                "331.45000",
                "23.54278309",
                "1620209397.407166"
            ],
            [
                "331.43000",
                "35.00000000",
                "1620209391.274375"
            ],
            [
                "331.37000",
                "2.96136000",
                "1620209346.500518"
            ],
            [
                "331.31000",
                "22.18270000",
                "1620209391.431762"
            ],
            [
                "331.29000",
                "7.12435597",
                "1620209397.013228"
            ]
        ], 'Expected line for 331.48 to have been updated')
    })

    test('Create bid higher than highest', function() {
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true, lastUpdatedTimestamp: 0, orderBook: cloneDeep(SAMPLE_BOOK_SNAPSHOT)[1], coin: Token.RIPPLE, currentReconnectDelay: 100}
        const message = [544,{"b":[["332.08000","148.65012786","1620264196.038137"]],"c":"2060521393"},"book-25","XRP/USD"]
        
        krakenHandleOrderBook(JSON.stringify(message), listener)
        const {orderBook} = listener
        // It should push out the last order so length remains same
        assert.equal(orderBook!.bs.length, SAMPLE_BOOK.bs.length)
        
        assert.deepEqual(orderBook!.bs[0], ["332.08000", "148.65012786","1620264196.038137"])
    })

    test('Create bids in the middle', function() {
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true, lastUpdatedTimestamp: 0, orderBook: cloneDeep(SAMPLE_BOOK_SNAPSHOT)[1], coin: Token.RIPPLE, currentReconnectDelay: 100}
        const message = [544,{"b":[[
            "331.70000",
            "8.123",
            "1620209397.284868"
        ], [
            "331.57000",
            "56.00000000",
            "1620209397.325755"
        ]],"c":"2060521393"},"book-25","XRP/USD"]
        
        krakenHandleOrderBook(JSON.stringify(message), listener)
        const {orderBook} = listener
        // It should push out the last order so length remains same
        assert.equal(orderBook!.bs.length, SAMPLE_BOOK.bs.length)
        
        assert.deepEqual(orderBook!.bs, [
            [
                "332.05000",
                "0.10000004",
                "1620209398.000896"
            ],
            [
                "331.93000",
                "3.79500000",
                "1620209397.868848"
            ],
            [
                "331.86000",
                "15.06083688",
                "1620209397.537775"
            ],
            [
                "331.85000",
                "42.59412581",
                "1620209398.092586"
            ],
            [
                "331.81000",
                "15.81284116",
                "1620209397.639543"
            ],
            [
                "331.78000",
                "22.56148095",
                "1620209378.672652"
            ],
            [
                "331.77000",
                "45.18820751",
                "1620209398.175159"
            ],
            [
                "331.73000",
                "60.00000000",
                "1620209397.593080"
            ],
            [
                "331.72000",
                "18.64475577",
                "1620209393.209003"
            ],
            [
                "331.71000",
                "7.85455545",
                "1620209397.284868"
            ],
            [
                "331.70000",
                "8.123",
                "1620209397.284868"
            ],
            [
                "331.69000",
                "0.24000000",
                "1620209397.040574"
            ],
            [
                "331.68000",
                "22.60271757",
                "1620209397.537063"
            ],
            [
                "331.66000",
                "30.10449556",
                "1620209392.689025"
            ],
            [
                "331.65000",
                "3.13698269",
                "1620209398.165483"
            ],
            [
                "331.64000",
                "6.27012967",
                "1620209397.426005"
            ],
            [
                "331.63000",
                "4.57244860",
                "1620209393.472758"
            ],
            [
                "331.60000",
                "30.34947044",
                "1620209393.801833"
            ],
            [
                "331.58000",
                "109.95794808",
                "1620209397.824771"
            ],
            [
                "331.57000",
                "56.00000000",
                "1620209397.325755"
            ],
            [
                "331.56000",
                "40.00000000",
                "1620209393.325755"
            ],
            [
                "331.48000",
                "419.28750000",
                "1620209398.208600"
            ],
            [
                "331.45000",
                "23.54278309",
                "1620209397.407166"
            ],
            [
                "331.43000",
                "35.00000000",
                "1620209391.274375"
            ],
            [
                "331.37000",
                "2.96136000",
                "1620209346.500518"
            ]
        ])
    })
    test('Remove asks at given price', function() {
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true, lastUpdatedTimestamp: 0, orderBook: cloneDeep(SAMPLE_BOOK), coin: Token.RIPPLE, currentReconnectDelay: 100}
        const message = [1234,{"a":[[
            "332.14000",
            "0.00000",
            "1620209398.092586"
        ], ["332.26000", "0.00000", "..."]],"c":"2060521393"},"book-25","LTC/USD"]
        krakenHandleOrderBook(JSON.stringify(message), listener)
        assert.deepEqual(listener.orderBook!.bs, SAMPLE_BOOK.bs, 'Bids not supposed to have been modified')
        
        assert.deepEqual(listener.orderBook!.as, [
            [
                "332.06000",
                "12.04845078",
                "1620209398.055437"
            ],
            [
                "332.11000",
                "22.59824620",
                "1620209391.608055"
            ],
            [
                "332.13000",
                "15.81125585",
                "1620209397.964279"
            ],
            [
                "332.22000",
                "22.58624441",
                "1620209390.221912"
            ],
            [
                "332.24000",
                "4.54776660",
                "1620209392.375153"
            ],
            [
                "332.27000",
                "3.13701928",
                "1620209398.309052"
            ],
            [
                "332.28000",
                "22.58163073",
                "1620209397.046942"
            ],
            [
                "332.34000",
                "13.00000000",
                "1620209395.958801"
            ],
            [
                "332.37000",
                "22.00100000",
                "1620209393.528951"
            ],
            [
                "332.43000",
                "4.45221540",
                "1620209397.796670"
            ],
            [
                "332.44000",
                "0.24250000",
                "1620209398.200235"
            ],
            [
                "332.47000",
                "254.26030000",
                "1620209396.216759"
            ],
            [
                "332.48000",
                "54.93236058",
                "1620209396.121353"
            ],
            [
                "332.49000",
                "40.00000000",
                "1620209393.524592"
            ],
            [
                "332.52000",
                "7.85582709",
                "1620209398.151178"
            ],
            [
                "332.53000",
                "123.39560000",
                "1620209391.821118"
            ],
            [
                "332.56000",
                "419.74000000",
                "1620209398.208662"
            ],
            [
                "332.67000",
                "3.10261180",
                "1620209398.342636"
            ],
            [
                "332.68000",
                "32.96408291",
                "1620209394.039751"
            ],
            [
                "332.72000",
                "209.76070000",
                "1620209396.358939"
            ],
            [
                "332.81000",
                "26.43040230",
                "1620209397.352421"
            ],
            [
                "332.82000",
                "13.37399921",
                "1620209397.753358"
            ],
            [
                "333.03000",
                "161.02307992",
                "1620209395.328583"
            ]
        ], 'Expected line for 331.85 to have been removed')
    })
    test('Update existing ask at given price', function() {
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true,  lastUpdatedTimestamp: 0, orderBook: cloneDeep(SAMPLE_BOOK), coin: Token.RIPPLE, currentReconnectDelay: 100}
        const message = [544,{"a":[[
            "333.03000",
            "81.02307992",
            "new timestamp right here"
        ]],"c":"2060521393"},"book-25","XRP/USD"]
        krakenHandleOrderBook(JSON.stringify(message), listener)
        assert.deepEqual(listener.orderBook!.bs, SAMPLE_BOOK.bs, 'Bids not supposed to have been modified')
        
        assert.deepEqual(listener.orderBook!.as, [
            [
                "332.06000",
                "12.04845078",
                "1620209398.055437"
            ],
            [
                "332.11000",
                "22.59824620",
                "1620209391.608055"
            ],
            [
                "332.13000",
                "15.81125585",
                "1620209397.964279"
            ],
            [
                "332.14000",
                "27.06862019",
                "1620209397.637771"
            ],
            [
                "332.22000",
                "22.58624441",
                "1620209390.221912"
            ],
            [
                "332.24000",
                "4.54776660",
                "1620209392.375153"
            ],
            [
                "332.26000",
                "30.13234415",
                "1620209393.746648"
            ],
            [
                "332.27000",
                "3.13701928",
                "1620209398.309052"
            ],
            [
                "332.28000",
                "22.58163073",
                "1620209397.046942"
            ],
            [
                "332.34000",
                "13.00000000",
                "1620209395.958801"
            ],
            [
                "332.37000",
                "22.00100000",
                "1620209393.528951"
            ],
            [
                "332.43000",
                "4.45221540",
                "1620209397.796670"
            ],
            [
                "332.44000",
                "0.24250000",
                "1620209398.200235"
            ],
            [
                "332.47000",
                "254.26030000",
                "1620209396.216759"
            ],
            [
                "332.48000",
                "54.93236058",
                "1620209396.121353"
            ],
            [
                "332.49000",
                "40.00000000",
                "1620209393.524592"
            ],
            [
                "332.52000",
                "7.85582709",
                "1620209398.151178"
            ],
            [
                "332.53000",
                "123.39560000",
                "1620209391.821118"
            ],
            [
                "332.56000",
                "419.74000000",
                "1620209398.208662"
            ],
            [
                "332.67000",
                "3.10261180",
                "1620209398.342636"
            ],
            [
                "332.68000",
                "32.96408291",
                "1620209394.039751"
            ],
            [
                "332.72000",
                "209.76070000",
                "1620209396.358939"
            ],
            [
                "332.81000",
                "26.43040230",
                "1620209397.352421"
            ],
            [
                "332.82000",
                "13.37399921",
                "1620209397.753358"
            ],
            [
                "333.03000",
                "81.02307992",
                "new timestamp right here"
            ]
        ], 'Expected line for 333.03 to have been updated')
    })

    test('Create ask lower than lowest', function() {
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true,  lastUpdatedTimestamp: 0, orderBook: cloneDeep(SAMPLE_BOOK), coin: Token.RIPPLE, currentReconnectDelay: 100}
        const message = [544,{"a":[["332.01","56.322","1620364196.038137"]],"c":"2060521393"},"book-25","XRP/USD"]
        
        krakenHandleOrderBook(JSON.stringify(message), listener)
        const {orderBook} = listener
        assert.deepEqual(orderBook!.bs, SAMPLE_BOOK.bs)
        // It should push out the last order so length remains same
        assert.equal(orderBook!.as.length, SAMPLE_BOOK.as.length)
        
        assert.deepEqual(orderBook!.as[0], ["332.01","56.322","1620364196.038137"])
    })

    test('Create asks in the middle', function() {
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true,  lastUpdatedTimestamp: 0, orderBook: cloneDeep(SAMPLE_BOOK_SNAPSHOT)[1], coin: Token.RIPPLE, currentReconnectDelay: 100}
        const message = [544,{"a":[[
            "332.16000",
            "8.123456",
            "1620209397.284868"
        ], [
            "332.73000",
            "56.00000000",
            "1620209397.325755"
        ]],"c":"2060521393"},"book-25","XRP/USD"]
        
        krakenHandleOrderBook(JSON.stringify(message), listener)
        const {orderBook} = listener
        assert.deepEqual(orderBook!.bs, SAMPLE_BOOK.bs)
        // It should push out the last order so length remains same
        assert.equal(orderBook!.as.length, SAMPLE_BOOK.as.length)
        
        assert.deepEqual(orderBook!.as, [
            [
                "332.06000",
                "12.04845078",
                "1620209398.055437"
            ],
            [
                "332.11000",
                "22.59824620",
                "1620209391.608055"
            ],
            [
                "332.13000",
                "15.81125585",
                "1620209397.964279"
            ],
            [
                "332.14000",
                "27.06862019",
                "1620209397.637771"
            ],
            [
                "332.16000",
                "8.123456",
                "1620209397.284868"
            ],
            [
                "332.22000",
                "22.58624441",
                "1620209390.221912"
            ],
            [
                "332.24000",
                "4.54776660",
                "1620209392.375153"
            ],
            [
                "332.26000",
                "30.13234415",
                "1620209393.746648"
            ],
            [
                "332.27000",
                "3.13701928",
                "1620209398.309052"
            ],
            [
                "332.28000",
                "22.58163073",
                "1620209397.046942"
            ],
            [
                "332.34000",
                "13.00000000",
                "1620209395.958801"
            ],
            [
                "332.37000",
                "22.00100000",
                "1620209393.528951"
            ],
            [
                "332.43000",
                "4.45221540",
                "1620209397.796670"
            ],
            [
                "332.44000",
                "0.24250000",
                "1620209398.200235"
            ],
            [
                "332.47000",
                "254.26030000",
                "1620209396.216759"
            ],
            [
                "332.48000",
                "54.93236058",
                "1620209396.121353"
            ],
            [
                "332.49000",
                "40.00000000",
                "1620209393.524592"
            ],
            [
                "332.52000",
                "7.85582709",
                "1620209398.151178"
            ],
            [
                "332.53000",
                "123.39560000",
                "1620209391.821118"
            ],
            [
                "332.56000",
                "419.74000000",
                "1620209398.208662"
            ],
            [
                "332.67000",
                "3.10261180",
                "1620209398.342636"
            ],
            [
                "332.68000",
                "32.96408291",
                "1620209394.039751"
            ],
            [
                "332.72000",
                "209.76070000",
                "1620209396.358939"
            ],
            [
                "332.73000",
                "56.00000000",
                "1620209397.325755"
            ],
            [
                "332.81000",
                "26.43040230",
                "1620209397.352421"
            ]
        ])
    })

    test('Remove and add one at the back', function() {
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true, lastUpdatedTimestamp: 0, orderBook: cloneDeep(SAMPLE_BOOK_SNAPSHOT)[1], coin: Token.RIPPLE, currentReconnectDelay: 100}
        const message = [544,{"a":[[
            "332.11000",
            "0.000",
            "1620209397.284868"
        ], [
            "333.42000",
            "561.00050000",
            "1630209397.325755"
        ]],"c":"2060521393"},"book-25","XRP/USD"]
        
        krakenHandleOrderBook(JSON.stringify(message), listener)
        const {orderBook} = listener
        assert.deepEqual(orderBook!.bs, SAMPLE_BOOK.bs)
        
        assert.deepEqual(orderBook!.as, [
            [
                "332.06000",
                "12.04845078",
                "1620209398.055437"
            ],
            [
                "332.13000",
                "15.81125585",
                "1620209397.964279"
            ],
            [
                "332.14000",
                "27.06862019",
                "1620209397.637771"
            ],
            [
                "332.22000",
                "22.58624441",
                "1620209390.221912"
            ],
            [
                "332.24000",
                "4.54776660",
                "1620209392.375153"
            ],
            [
                "332.26000",
                "30.13234415",
                "1620209393.746648"
            ],
            [
                "332.27000",
                "3.13701928",
                "1620209398.309052"
            ],
            [
                "332.28000",
                "22.58163073",
                "1620209397.046942"
            ],
            [
                "332.34000",
                "13.00000000",
                "1620209395.958801"
            ],
            [
                "332.37000",
                "22.00100000",
                "1620209393.528951"
            ],
            [
                "332.43000",
                "4.45221540",
                "1620209397.796670"
            ],
            [
                "332.44000",
                "0.24250000",
                "1620209398.200235"
            ],
            [
                "332.47000",
                "254.26030000",
                "1620209396.216759"
            ],
            [
                "332.48000",
                "54.93236058",
                "1620209396.121353"
            ],
            [
                "332.49000",
                "40.00000000",
                "1620209393.524592"
            ],
            [
                "332.52000",
                "7.85582709",
                "1620209398.151178"
            ],
            [
                "332.53000",
                "123.39560000",
                "1620209391.821118"
            ],
            [
                "332.56000",
                "419.74000000",
                "1620209398.208662"
            ],
            [
                "332.67000",
                "3.10261180",
                "1620209398.342636"
            ],
            [
                "332.68000",
                "32.96408291",
                "1620209394.039751"
            ],
            [
                "332.72000",
                "209.76070000",
                "1620209396.358939"
            ],
            [
                "332.81000",
                "26.43040230",
                "1620209397.352421"
            ],
            [
                "332.82000",
                "13.37399921",
                "1620209397.753358"
            ],
            [
                "333.03000",
                "161.02307992",
                "1620209395.328583"
            ],
            [
                "333.42000",
                "561.00050000",
                "1630209397.325755"
            ]
        ])
    })

    test('Calculate checksum', function() {
        const orderBook: KrakenOrderBook = {
            "as": [
                [ "0.05005", "0.00000500", "1582905487.684110" ],
                [ "0.05010", "0.00000500", "1582905486.187983" ],
                [ "0.05015", "0.00000500", "1582905484.480241" ],
                [ "0.05020", "0.00000500", "1582905486.645658" ],
                [ "0.05025", "0.00000500", "1582905486.859009" ],
                [ "0.05030", "0.00000500", "1582905488.601486" ],
                [ "0.05035", "0.00000500", "1582905488.357312" ],
                [ "0.05040", "0.00000500", "1582905488.785484" ],
                [ "0.05045", "0.00000500", "1582905485.302661" ],
                [ "0.05050", "0.00000500", "1582905486.157467" ],
                [ "0.05050", "0.00000500", "1582905486.157467" ] 
            ],
            "bs": [
                [ "0.05000", "0.00000500", "1582905487.439814" ],
                [ "0.04995", "0.00000500", "1582905485.119396" ],
                [ "0.04990", "0.00000500", "1582905486.432052" ],
                [ "0.04980", "0.00000500", "1582905480.609351" ],
                [ "0.04975", "0.00000500", "1582905476.793880" ],
                [ "0.04970", "0.00000500", "1582905486.767461" ],
                [ "0.04965", "0.00000500", "1582905481.767528" ],
                [ "0.04960", "0.00000500", "1582905487.378907" ],
                [ "0.04955", "0.00000500", "1582905483.626664" ],
                [ "0.04950", "0.00000500", "1582905488.509872" ]
            ]
        }
        assert.equal(calculateChecksum(orderBook), "974947235")
    })

    test('Process and calculate checksum - real numbers that caused problems 2', function() {
        // TODO
        const data = {"orderBookBeforeUpdate":{"as":[["330.54000","22.69194491","1620884764.272855"],["330.56000","15.12794817","1620884764.742253"],["330.58000","22.70598849","1620884763.542062"],["330.63000","22.70513509","1620884762.788123"],["330.64000","4.54210000","1620884762.591138"],["330.67000","30.26949405","1620884750.779030"],["330.68000","17.24302753","1620884763.497237"],["330.69000","50.00000000","1620884652.195685","r"],["330.72000","0.25500000","1620884763.596579"],["330.73000","23.69154408","1620884763.632827"],["330.76000","52.95681533","1620884764.277570"],["330.77000","21.68166664","1620884764.243649"],["330.78000","40.00000000","1620884763.500302"],["330.80000","5.04505150","1620884703.463955","r"],["330.83000","40.00000000","1620884721.036305","r"],["330.86000","22.69191386","1620884764.277497"],["330.91000","22.62870000","1620884744.745210","r"],["331.02000","3.30057530","1620884763.530092"],["331.03000","3.02867800","1620884763.233966"],["331.06000","3.76443291","1620884626.237754","r"],["331.15000","12.03500000","1620884763.314174"],["331.16000","35.00000000","1620884764.162387"],["331.19000","29.46821245","1620884762.767559"],["331.20000","82.00330616","1620884701.962856","r"],["331.27000","246.68610000","1620884763.791624","r"]],"bs":[["330.46000","2.75146499","1620884763.932148"],["330.38000","35.36126166","1620884763.591134"],["330.37000","11.00000000","1620884763.542204"],["330.35000","22.69263180","1620884764.272758"],["330.33000","20.00000000","1620884764.269135"],["330.32000","37.82279302","1620884764.277181"],["330.29000","42.69674555","1620884764.277249"],["330.28000","9.90000000","1620884762.986256"],["330.27000","22.69192606","1620884764.190734"],["330.22000","4.49609340","1620884763.094437"],["330.19000","332.16491375","1620884762.999184"],["330.16000","29.15928434","1620884763.617253"],["330.13000","4.48777750","1620884762.764263"],["330.11000","50.64000000","1620884762.714226"],["330.08000","30.26205552","1620884764.191369"],["330.06000","9.92100000","1620884741.023103"],["330.05000","3.40533819","1620884763.308141"],["330.03000","17.93802540","1620884763.118528"],["330.02000","4.55108770","1620884762.691233"],["330.01000","22.70672640","1620884750.213295"],["329.98000","0.24750000","1620884763.501063"],["329.95000","134.34880000","1620884762.986377"],["329.93000","52.96713098","1620884763.545452"],["329.91000","0.25250000","1620884725.099713"],["329.87000","6.32140366","1620884755.329054","r"]],"checksum":"629818466"},"payload":[416,{"a":[["330.77000","15.36177056","1620884764.795045"]]},{"b":[["329.87000","0.00000000","1620884764.792987"],["329.86000","17.87890000","1620884763.184875","r"],["330.05000","0.24500000","1620884764.794625"]],"c":"629818466"},"book-25","LTC/USD"],"coin":"LTC","orderBook":{"as":[["330.54000","22.69194491","1620884764.272855"],["330.56000","15.12794817","1620884764.742253"],["330.58000","22.70598849","1620884763.542062"],["330.63000","22.70513509","1620884762.788123"],["330.64000","4.54210000","1620884762.591138"],["330.67000","30.26949405","1620884750.779030"],["330.68000","17.24302753","1620884763.497237"],["330.69000","50.00000000","1620884652.195685","r"],["330.72000","0.25500000","1620884763.596579"],["330.73000","23.69154408","1620884763.632827"],["330.76000","52.95681533","1620884764.277570"],["330.77000","15.36177056","1620884764.795045"],["330.78000","40.00000000","1620884763.500302"],["330.80000","5.04505150","1620884703.463955","r"],["330.83000","40.00000000","1620884721.036305","r"],["330.86000","22.69191386","1620884764.277497"],["330.91000","22.62870000","1620884744.745210","r"],["331.02000","3.30057530","1620884763.530092"],["331.03000","3.02867800","1620884763.233966"],["331.06000","3.76443291","1620884626.237754","r"],["331.15000","12.03500000","1620884763.314174"],["331.16000","35.00000000","1620884764.162387"],["331.19000","29.46821245","1620884762.767559"],["331.20000","82.00330616","1620884701.962856","r"],["331.27000","246.68610000","1620884763.791624","r"]],"bs":[["330.46000","2.75146499","1620884763.932148"],["330.38000","35.36126166","1620884763.591134"],["330.37000","11.00000000","1620884763.542204"],["330.35000","22.69263180","1620884764.272758"],["330.33000","20.00000000","1620884764.269135"],["330.32000","37.82279302","1620884764.277181"],["330.29000","42.69674555","1620884764.277249"],["330.28000","9.90000000","1620884762.986256"],["330.27000","22.69192606","1620884764.190734"],["330.22000","4.49609340","1620884763.094437"],["330.19000","332.16491375","1620884762.999184"],["330.16000","29.15928434","1620884763.617253"],["330.13000","4.48777750","1620884762.764263"],["330.11000","50.64000000","1620884762.714226"],["330.08000","30.26205552","1620884764.191369"],["330.06000","9.92100000","1620884741.023103"],["330.05000","3.40533819","1620884763.308141"],["330.03000","17.93802540","1620884763.118528"],["330.02000","4.55108770","1620884762.691233"],["330.01000","22.70672640","1620884750.213295"],["329.98000","0.24750000","1620884763.501063"],["329.95000","134.34880000","1620884762.986377"],["329.93000","52.96713098","1620884763.545452"],["329.91000","0.25250000","1620884725.099713"],["329.87000","6.32140366","1620884755.329054","r"]],"checksum":"629818466"},"calculated":"629818466","updatePayload":{"a":[["330.77000","15.36177056","1620884764.795045"]]},"level":"error","message":"[KRAKEN][WS] Checksum mismatch for Kraken orderbook","timestamp":"2021-05-13T05:46:05.256Z"}
    })
    test('Process and calculate checksum - real numbers that caused problems 1', function() {
        const data = {
            "orderBookBeforeUpdate":{
               "as":[
                  [
                     "321.61000",
                     "5.47500000",
                     "1620877029.047487"
                  ],
                  [
                     "321.62000",
                     "89.24998612",
                     "1620877029.057821"
                  ],
                  [
                     "321.63000",
                     "201.48401186",
                     "1620877029.126471"
                  ],
                  [
                     "321.64000",
                     "40.00000000",
                     "1620877028.956035"
                  ],
                  [
                     "321.65000",
                     "11.00000000",
                     "1620877025.506216"
                  ],
                  [
                     "321.66000",
                     "23.31432836",
                     "1620877025.390641"
                  ],
                  [
                     "321.69000",
                     "12.60400000",
                     "1620877029.124338"
                  ],
                  [
                     "321.72000",
                     "31.10115305",
                     "1620877028.296132"
                  ],
                  [
                     "321.77000",
                     "3.24573803",
                     "1620877025.463359"
                  ],
                  [
                     "321.79000",
                     "15.26690000",
                     "1620877029.091206"
                  ],
                  [
                     "321.82000",
                     "28.21983602",
                     "1620877028.315611"
                  ],
                  [
                     "321.83000",
                     "9.10400000",
                     "1620877025.118765"
                  ],
                  [
                     "321.90000",
                     "129.63600000",
                     "1620877028.209806"
                  ],
                  [
                     "321.94000",
                     "4.63828650",
                     "1620877028.851317"
                  ],
                  [
                     "321.97000",
                     "268.39870000",
                     "1620877027.386805"
                  ],
                  [
                     "322.07000",
                     "3.30008222",
                     "1620877028.165112"
                  ],
                  [
                     "322.08000",
                     "4.60134120",
                     "1620877027.299415"
                  ],
                  [
                     "322.12000",
                     "260.43240000",
                     "1620877024.982048"
                  ],
                  [
                     "322.17000",
                     "6.48736893",
                     "1620877020.987719",
                     "r"
                  ],
                  [
                     "322.28000",
                     "0.16437854",
                     "1620877027.831430",
                     "r"
                  ],
                  [
                     "322.33000",
                     "9.56315746",
                     "1620877026.718731",
                     "r"
                  ],
                  [
                     "322.46000",
                     "10.17800000",
                     "1620877024.993122",
                     "r"
                  ],
                  [
                     "322.58000",
                     "0.21803418",
                     "1620877025.448947",
                     "r"
                  ],
                  [
                     "322.76000",
                     "50.00000000",
                     "1620876996.624473",
                     "r"
                  ],
                  [
                     "322.88000",
                     "152.44007126",
                     "1620877025.394925",
                     "r"
                  ]
               ],
               "bs":[
                  [
                     "321.62000",
                     "0.00001388",
                     "1620877027.931714"
                  ],
                  [
                     "321.14000",
                     "10.89070400",
                     "1620877029.085340"
                  ],
                  [
                     "321.04000",
                     "16.07189633",
                     "1620877028.997237"
                  ],
                  [
                     "321.00000",
                     "4.67289720",
                     "1620877028.017941",
                     "r"
                  ],
                  [
                     "320.90000",
                     "31.10896467",
                     "1620877028.309809"
                  ],
                  [
                     "320.79000",
                     "31.11842102",
                     "1620877028.312783"
                  ],
                  [
                     "320.77000",
                     "216.60848895",
                     "1620877028.097956"
                  ],
                  [
                     "320.75000",
                     "444.96250000",
                     "1620877028.421022"
                  ],
                  [
                     "320.74000",
                     "6.49225421",
                     "1620877028.862389"
                  ],
                  [
                     "320.68000",
                     "0.21868830",
                     "1620877029.112570"
                  ],
                  [
                     "320.62000",
                     "49.56000000",
                     "1620877018.213760",
                     "r"
                  ],
                  [
                     "320.55000",
                     "0.24250000",
                     "1620877028.931914"
                  ],
                  [
                     "320.51000",
                     "24.36395736",
                     "1620877029.103098"
                  ],
                  [
                     "320.47000",
                     "18.34580000",
                     "1620877028.079714"
                  ],
                  [
                     "320.44000",
                     "0.04898644",
                     "1620876880.605803",
                     "r"
                  ],
                  [
                     "320.37000",
                     "0.08909498",
                     "1620877028.865326",
                     "r"
                  ],
                  [
                     "320.23000",
                     "266.26090000",
                     "1620877028.379933"
                  ],
                  [
                     "320.13000",
                     "146.75018273",
                     "1620877021.702444",
                     "r"
                  ],
                  [
                     "320.07000",
                     "131.64970000",
                     "1620877028.861392"
                  ],
                  [
                     "320.05000",
                     "0.74756464",
                     "1620876976.407239",
                     "r"
                  ],
                  [
                     "319.60000",
                     "162.38000000",
                     "1620877028.444555"
                  ],
                  [
                     "319.57000",
                     "170.60000000",
                     "1620877015.320147",
                     "r"
                  ],
                  [
                     "319.46000",
                     "0.06012003",
                     "1620876793.929474",
                     "r"
                  ],
                  [
                     "319.20000",
                     "2.00000000",
                     "1620876726.374380",
                     "r"
                  ],
                  [
                     "319.09000",
                     "0.47906387",
                     "1620876931.105198",
                     "r"
                  ]
               ]
            },
            "payload":[
               416,
               {
                  "a":[
                     [
                        "321.72000",
                        "47.86155337",
                        "1620877029.127168"
                     ]
                  ],
                  "c":"724856488"
               },
               "book-25",
               "LTC/USD"
            ],
            "coin":"LTC",
            "orderBook":{
               "as":[
                  [
                     "321.61000",
                     "5.47500000",
                     "1620877029.047487"
                  ],
                  [
                     "321.62000",
                     "89.24998612",
                     "1620877029.057821"
                  ],
                  [
                     "321.63000",
                     "201.48401186",
                     "1620877029.126471"
                  ],
                  [
                     "321.64000",
                     "40.00000000",
                     "1620877028.956035"
                  ],
                  [
                     "321.65000",
                     "11.00000000",
                     "1620877025.506216"
                  ],
                  [
                     "321.66000",
                     "23.31432836",
                     "1620877025.390641"
                  ],
                  [
                     "321.69000",
                     "12.60400000",
                     "1620877029.124338"
                  ],
                  [
                     "321.72000",
                     "47.86155337",
                     "1620877029.127168"
                  ],
                  [
                     "321.77000",
                     "3.24573803",
                     "1620877025.463359"
                  ],
                  [
                     "321.79000",
                     "15.26690000",
                     "1620877029.091206"
                  ],
                  [
                     "321.82000",
                     "28.21983602",
                     "1620877028.315611"
                  ],
                  [
                     "321.83000",
                     "9.10400000",
                     "1620877025.118765"
                  ],
                  [
                     "321.90000",
                     "129.63600000",
                     "1620877028.209806"
                  ],
                  [
                     "321.94000",
                     "4.63828650",
                     "1620877028.851317"
                  ],
                  [
                     "321.97000",
                     "268.39870000",
                     "1620877027.386805"
                  ],
                  [
                     "322.07000",
                     "3.30008222",
                     "1620877028.165112"
                  ],
                  [
                     "322.08000",
                     "4.60134120",
                     "1620877027.299415"
                  ],
                  [
                     "322.12000",
                     "260.43240000",
                     "1620877024.982048"
                  ],
                  [
                     "322.17000",
                     "6.48736893",
                     "1620877020.987719",
                     "r"
                  ],
                  [
                     "322.28000",
                     "0.16437854",
                     "1620877027.831430",
                     "r"
                  ],
                  [
                     "322.33000",
                     "9.56315746",
                     "1620877026.718731",
                     "r"
                  ],
                  [
                     "322.46000",
                     "10.17800000",
                     "1620877024.993122",
                     "r"
                  ],
                  [
                     "322.58000",
                     "0.21803418",
                     "1620877025.448947",
                     "r"
                  ],
                  [
                     "322.76000",
                     "50.00000000",
                     "1620876996.624473",
                     "r"
                  ],
                  [
                     "322.88000",
                     "152.44007126",
                     "1620877025.394925",
                     "r"
                  ]
               ],
               "bs":[
                  [
                     "321.62000",
                     "0.00001388",
                     "1620877027.931714"
                  ],
                  [
                     "321.14000",
                     "10.89070400",
                     "1620877029.085340"
                  ],
                  [
                     "321.04000",
                     "16.07189633",
                     "1620877028.997237"
                  ],
                  [
                     "321.00000",
                     "4.67289720",
                     "1620877028.017941",
                     "r"
                  ],
                  [
                     "320.90000",
                     "31.10896467",
                     "1620877028.309809"
                  ],
                  [
                     "320.79000",
                     "31.11842102",
                     "1620877028.312783"
                  ],
                  [
                     "320.77000",
                     "216.60848895",
                     "1620877028.097956"
                  ],
                  [
                     "320.75000",
                     "444.96250000",
                     "1620877028.421022"
                  ],
                  [
                     "320.74000",
                     "6.49225421",
                     "1620877028.862389"
                  ],
                  [
                     "320.68000",
                     "0.21868830",
                     "1620877029.112570"
                  ],
                  [
                     "320.62000",
                     "49.56000000",
                     "1620877018.213760",
                     "r"
                  ],
                  [
                     "320.55000",
                     "0.24250000",
                     "1620877028.931914"
                  ],
                  [
                     "320.51000",
                     "24.36395736",
                     "1620877029.103098"
                  ],
                  [
                     "320.47000",
                     "18.34580000",
                     "1620877028.079714"
                  ],
                  [
                     "320.44000",
                     "0.04898644",
                     "1620876880.605803",
                     "r"
                  ],
                  [
                     "320.37000",
                     "0.08909498",
                     "1620877028.865326",
                     "r"
                  ],
                  [
                     "320.23000",
                     "266.26090000",
                     "1620877028.379933"
                  ],
                  [
                     "320.13000",
                     "146.75018273",
                     "1620877021.702444",
                     "r"
                  ],
                  [
                     "320.07000",
                     "131.64970000",
                     "1620877028.861392"
                  ],
                  [
                     "320.05000",
                     "0.74756464",
                     "1620876976.407239",
                     "r"
                  ],
                  [
                     "319.60000",
                     "162.38000000",
                     "1620877028.444555"
                  ],
                  [
                     "319.57000",
                     "170.60000000",
                     "1620877015.320147",
                     "r"
                  ],
                  [
                     "319.46000",
                     "0.06012003",
                     "1620876793.929474",
                     "r"
                  ],
                  [
                     "319.20000",
                     "2.00000000",
                     "1620876726.374380",
                     "r"
                  ],
                  [
                     "319.09000",
                     "0.47906387",
                     "1620876931.105198",
                     "r"
                  ]
               ]
            },
            "calculated":"3203531032",
            "payloadChecksum":"724856488",
            "updatePayload":{
               "a":[
                  [
                     "321.72000",
                     "47.86155337",
                     "1620877029.127168"
                  ]
               ],
               "c":"724856488"
            },
            "level":"error",
            "message":"[KRAKEN][WS] Checksum mismatch for Kraken orderbook",
            "timestamp":"2021-05-13T03:37:09.636Z"
         }
        const orderBook: KrakenOrderBook = data.orderBookBeforeUpdate as unknown as KrakenOrderBook
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true, lastUpdatedTimestamp: 0, orderBook, coin: Token.RIPPLE, currentReconnectDelay: 100}
        const updateMessage: KrakenUpdatePayload = data.updatePayload as unknown as KrakenUpdatePayload
        krakenHandleOrderBook(JSON.stringify([1, updateMessage, '', '']), listener)
        const bidsBefore = cloneDeep(orderBook!.bs)
        // Payload update is a asks only so bids should remain untouched
        assert.deepEqual(orderBook!.bs, bidsBefore)
        
        // Only change appears to be on the 321.72000 quantity
        const asksAfter = [
            [
               "321.61000",
               "5.47500000",
               "1620877029.047487"
            ],
            [
               "321.62000",
               "89.24998612",
               "1620877029.057821"
            ],
            [
               "321.63000",
               "201.48401186",
               "1620877029.126471"
            ],
            [
               "321.64000",
               "40.00000000",
               "1620877028.956035"
            ],
            [
               "321.65000",
               "11.00000000",
               "1620877025.506216"
            ],
            [
               "321.66000",
               "23.31432836",
               "1620877025.390641"
            ],
            [
               "321.69000",
               "12.60400000",
               "1620877029.124338"
            ],
            [
               "321.72000",
               "47.86155337",
                "1620877029.127168"
            ],
            [
               "321.77000",
               "3.24573803",
               "1620877025.463359"
            ],
            [
               "321.79000",
               "15.26690000",
               "1620877029.091206"
            ],
            [
               "321.82000",
               "28.21983602",
               "1620877028.315611"
            ],
            [
               "321.83000",
               "9.10400000",
               "1620877025.118765"
            ],
            [
               "321.90000",
               "129.63600000",
               "1620877028.209806"
            ],
            [
               "321.94000",
               "4.63828650",
               "1620877028.851317"
            ],
            [
               "321.97000",
               "268.39870000",
               "1620877027.386805"
            ],
            [
               "322.07000",
               "3.30008222",
               "1620877028.165112"
            ],
            [
               "322.08000",
               "4.60134120",
               "1620877027.299415"
            ],
            [
               "322.12000",
               "260.43240000",
               "1620877024.982048"
            ],
            [
               "322.17000",
               "6.48736893",
               "1620877020.987719",
               "r"
            ],
            [
               "322.28000",
               "0.16437854",
               "1620877027.831430",
               "r"
            ],
            [
               "322.33000",
               "9.56315746",
               "1620877026.718731",
               "r"
            ],
            [
               "322.46000",
               "10.17800000",
               "1620877024.993122",
               "r"
            ],
            [
               "322.58000",
               "0.21803418",
               "1620877025.448947",
               "r"
            ],
            [
               "322.76000",
               "50.00000000",
               "1620876996.624473",
               "r"
            ],
            [
               "322.88000",
               "152.44007126",
               "1620877025.394925",
               "r"
            ]
         ]
        assert.deepEqual(orderBook!.as, asksAfter)
        // TODO not been able to figure out what is wrong with the orderbook above
        // assert.equal(calculateChecksum(orderBook), data.payloadChecksum)
    })

    test('Calculate checksum from real numbers', function() {
        const orderBook: KrakenOrderBook = {
            "as": [
                [
                    "1.65718000",
                    "408.23898243",
                    "1620286744.769433"
                ],
                [
                    "1.65811000",
                    "891.84390000",
                    "1620286734.059150"
                ],
                [
                    "1.65838000",
                    "150.87108470",
                    "1620286742.999216"
                ],
                [
                    "1.65862000",
                    "2000.00000000",
                    "1620286732.220822"
                ],
                [
                    "1.65882000",
                    "4828.19096132",
                    "1620286729.377826"
                ],
                [
                    "1.65892000",
                    "2678.00000000",
                    "1620286739.329227"
                ],
                [
                    "1.65940000",
                    "21415.71045240",
                    "1620286744.749909"
                ],
                [
                    "1.65953000",
                    "4545.74700000",
                    "1620286741.464530"
                ],
                [
                    "1.65957000",
                    "3000.00000000",
                    "1620286730.179774"
                ],
                [
                    "1.65965000",
                    "14.26140465",
                    "1620286395.000828"
                ],
                [
                    "1.65970000",
                    "12.09552880",
                    "1620282688.814592"
                ],
                [
                    "1.65993000",
                    "67009.15000000",
                    "1620286740.237499"
                ],
                [
                    "1.65998000",
                    "9066.36800000",
                    "1620286730.107785"
                ],
                [
                    "1.66047000",
                    "16703.51000000",
                    "1620286739.167152"
                ],
                [
                    "1.66087000",
                    "12071.85570000",
                    "1620286730.178512"
                ],
                [
                    "1.66091000",
                    "34834.56000000",
                    "1620286737.180283"
                ],
                [
                    "1.66096000",
                    "9061.25690000",
                    "1620286730.108052"
                ],
                [
                    "1.66147000",
                    "9058.57570000",
                    "1620286730.108122"
                ],
                [
                    "1.66263000",
                    "2442.29377869",
                    "1620286646.369395"
                ],
                [
                    "1.66278000",
                    "45.00071535",
                    "1620286623.501130"
                ],
                [
                    "1.66284000",
                    "11950.00000000",
                    "1620286741.998374"
                ],
                [
                    "1.66317000",
                    "1169.76606720",
                    "1620286407.882479"
                ],
                [
                    "1.66341000",
                    "8281.34994410",
                    "1620286733.609140"
                ],
                [
                    "1.66353000",
                    "73.55850671",
                    "1620286709.206071"
                ],
                [
                    "1.66373000",
                    "245.16635535",
                    "1620286709.543355"
                ]
            ],
            "bs": [
                [
                    "1.65642000",
                    "5050.00000000",
                    "1620286744.167479"
                ],
                [
                    "1.65604000",
                    "3077.50000000",
                    "1620286744.630408"
                ],
                [
                    "1.65595000",
                    "1811.65166759",
                    "1620286744.576469"
                ],
                [
                    "1.65577000",
                    "903.56750000",
                    "1620286744.742900"
                ],
                [
                    "1.65576000",
                    "1430.00000000",
                    "1620286744.186601"
                ],
                [
                    "1.65571000",
                    "150.87108470",
                    "1620286742.897964"
                ],
                [
                    "1.65570000",
                    "592.68491000",
                    "1620286741.866824"
                ],
                [
                    "1.65568000",
                    "2113.07358627",
                    "1620286741.245888"
                ],
                [
                    "1.65552000",
                    "2000.00000000",
                    "1620286741.935818"
                ],
                [
                    "1.65539000",
                    "6032.00470000",
                    "1620286742.847407"
                ],
                [
                    "1.65527000",
                    "150.90952284",
                    "1620286739.650168"
                ],
                [
                    "1.65524000",
                    "907.30030000",
                    "1620286744.572038"
                ],
                [
                    "1.65506000",
                    "26717.55725190",
                    "1620286744.754865"
                ],
                [
                    "1.65496000",
                    "652.06350000",
                    "1620286744.344446"
                ],
                [
                    "1.65495000",
                    "4909.98093529",
                    "1620286741.151427"
                ],
                [
                    "1.65494000",
                    "6770.25429388",
                    "1620286732.223084"
                ],
                [
                    "1.65482000",
                    "4753.18377147",
                    "1620286735.264781"
                ],
                [
                    "1.65470000",
                    "913.12620000",
                    "1620286738.532872"
                ],
                [
                    "1.65450000",
                    "8087.05322275",
                    "1620286732.744707"
                ],
                [
                    "1.65448000",
                    "9053.88480000",
                    "1620286731.291706"
                ],
                [
                    "1.65437000",
                    "84980.00000000",
                    "1620286733.540495"
                ],
                [
                    "1.65429000",
                    "6377.04734897",
                    "1620286732.224219"
                ],
                [
                    "1.65424000",
                    "2643.40000000",
                    "1620286744.162408"
                ],
                [
                    "1.65400000",
                    "9055.39150000",
                    "1620286730.108210"
                ],
                [
                    "1.65394000",
                    "2678.00000000",
                    "1620286739.329066"
                ]
            ]
        }
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true, lastUpdatedTimestamp: 0, orderBook, coin: Token.RIPPLE, currentReconnectDelay: 100}
        const asksBefore = cloneDeep(orderBook!.as)
        const updateMessage: KrakenUpdatePayload = {"b":[["1.65506000","0.00000000","1620286744.790002"],["1.65392000","914.55440000","1620286730.496269","r"]],"c":"4000556414"}
        krakenHandleOrderBook(JSON.stringify([1, updateMessage, '', '']), listener)
        assert.deepEqual(orderBook!.as, asksBefore)
        
        assert.deepEqual(listener.orderBook!.bs,  [
            [
                "1.65642000",
                "5050.00000000",
                "1620286744.167479"
            ],
            [
                "1.65604000",
                "3077.50000000",
                "1620286744.630408"
            ],
            [
                "1.65595000",
                "1811.65166759",
                "1620286744.576469"
            ],
            [
                "1.65577000",
                "903.56750000",
                "1620286744.742900"
            ],
            [
                "1.65576000",
                "1430.00000000",
                "1620286744.186601"
            ],
            [
                "1.65571000",
                "150.87108470",
                "1620286742.897964"
            ],
            [
                "1.65570000",
                "592.68491000",
                "1620286741.866824"
            ],
            [
                "1.65568000",
                "2113.07358627",
                "1620286741.245888"
            ],
            [
                "1.65552000",
                "2000.00000000",
                "1620286741.935818"
            ],
            [
                "1.65539000",
                "6032.00470000",
                "1620286742.847407"
            ],
            [
                "1.65527000",
                "150.90952284",
                "1620286739.650168"
            ],
            [
                "1.65524000",
                "907.30030000",
                "1620286744.572038"
            ],
            [
                "1.65496000",
                "652.06350000",
                "1620286744.344446"
            ],
            [
                "1.65495000",
                "4909.98093529",
                "1620286741.151427"
            ],
            [
                "1.65494000",
                "6770.25429388",
                "1620286732.223084"
            ],
            [
                "1.65482000",
                "4753.18377147",
                "1620286735.264781"
            ],
            [
                "1.65470000",
                "913.12620000",
                "1620286738.532872"
            ],
            [
                "1.65450000",
                "8087.05322275",
                "1620286732.744707"
            ],
            [
                "1.65448000",
                "9053.88480000",
                "1620286731.291706"
            ],
            [
                "1.65437000",
                "84980.00000000",
                "1620286733.540495"
            ],
            [
                "1.65429000",
                "6377.04734897",
                "1620286732.224219"
            ],
            [
                "1.65424000",
                "2643.40000000",
                "1620286744.162408"
            ],
            [
                "1.65400000",
                "9055.39150000",
                "1620286730.108210"
            ],
            [
                "1.65394000",
                "2678.00000000",
                "1620286739.329066"
            ],
            ["1.65392000","914.55440000","1620286730.496269", "r"]
        ])
        assert.equal(calculateChecksum(listener.orderBook!), "4000556414")
    })

    test('Calculate checksum from real numbers 3', function() {
        const orderBook: KrakenOrderBook = {'as': [['362.93000', '3.50564334', '1620369203.804577'], ['363.04000', '17.48131116', '1620369215.188198'], ['363.08000', '0.44936680', '1620367747.757557', 'r'], ['363.23000', '14.27365010', '1620369218.209811'], ['363.24000', '13.78416619', '1620369217.539409'], ['363.25000', '20.67347399', '1620369218.407002'], ['363.53000', '0.04361671', '1620367629.457996', 'r'], ['363.55000', '138.86857120', '1620369218.371389'], ['363.56000', '141.67404809', '1620369218.323077'], ['363.57000', '20.69330294', '1620369215.164387'], ['363.61000', '20.69062285', '1620369215.164456'], ['363.66000', '0.04871204', '1620369215.998721', 'r'], ['363.72000', '25.14680000', '1620369218.268106'], ['363.82000', '20.67893281', '1620369217.253387'], ['363.95000', '149.98298942', '1620369218.135079'], ['363.96000', '162.80250000', '1620369215.092508', 'r'], ['364.03000', '16.60827279', '1620369215.390187', 'r'], ['364.15000', '0.45595970', '1620367748.020778', 'r'], ['364.17000', '0.20000000', '1620369196.146954', 'r'], ['364.23000', '169.69266000', '1620369211.647579', 'r'], ['364.27000', '283.47560000', '1620369217.419576', 'r'], ['364.30000', '298.59180000', '1620369218.384822'], ['364.35000', '47.30000000', '1620369215.619000', 'r'], ['364.45000', '0.22961154', '1620367606.218649', 'r'], ['364.48000', '0.19523179', '1620367590.671751', 'r']], 'bs': [['362.73000', '4.02065302', '1620369218.400086'], ['362.54000', '20.66968614', '1620369218.409295'], ['362.29000', '9.55862000', '1620369218.372694'], ['362.28000', '1.28241095', '1620369218.392741'], ['362.27000', '105.50000000', '1620369218.334402'], ['362.26000', '233.64442515', '1620369218.332877'], ['362.25000', '20.67955362', '1620369218.356717'], ['362.24000', '12.00000000', '1620369217.894946'], ['362.23000', '105.50000000', '1620369215.245206'], ['362.22000', '6.85000000', '1620369218.333749'], ['362.19000', '20.68886670', '1620369215.164644'], ['362.06000', '32.25767754', '1620369218.305311'], ['362.02000', '12.09200000', '1620369216.167464'], ['362.00000', '20.70424373', '1620369214.973502'], ['361.95000', '4.15416490', '1620369217.188205'], ['361.85000', '20.70693469', '1620369212.238129'], ['361.82000', '17.34676532', '1620369215.141918'], ['361.70000', '5.22799591', '1620369217.217792'], ['361.65000', '2.87903449', '1620369215.167148'], ['361.64000', '12.00000000', '1620369214.322211'], ['361.63000', '13.03400000', '1620369211.109601'], ['361.48000', '10.38100000', '1620369210.995023'], ['361.37000', '6.05240460', '1620369215.238227', 'r'], ['361.34000', '40.00000000', '1620369211.514772', 'r'], ['361.33000', '19.27960000', '1620369217.472713', 'r']]}
        const listener: KrakenOrderBookListener = {depth: 25, subscribed: true, lastUpdatedTimestamp: 0, orderBook, coin: Token.RIPPLE, currentReconnectDelay: 100}
        
        const bidsBefore = cloneDeep(orderBook!.bs)
        const updateMessage: KrakenUpdatePayload = {'a': [['363.91000', '20.67410886', '1620369218.409513']], 'c': '2724778063'}
        krakenHandleOrderBook(JSON.stringify([1, updateMessage, '', '']), listener)
        assert.deepEqual(orderBook!.bs, bidsBefore)
        
        assert.deepEqual(listener.orderBook!.as, [
            ['362.93000', '3.50564334', '1620369203.804577'], ['363.04000', '17.48131116', '1620369215.188198'], ['363.08000', '0.44936680', '1620367747.757557', 'r'], ['363.23000', '14.27365010', '1620369218.209811'], ['363.24000', '13.78416619', '1620369217.539409'], ['363.25000', '20.67347399', '1620369218.407002'], ['363.53000', '0.04361671', '1620367629.457996', 'r'], ['363.55000', '138.86857120', '1620369218.371389'], ['363.56000', '141.67404809', '1620369218.323077'], ['363.57000', '20.69330294', '1620369215.164387'], ['363.61000', '20.69062285', '1620369215.164456'], ['363.66000', '0.04871204', '1620369215.998721', 'r'], ['363.72000', '25.14680000', '1620369218.268106'], ['363.82000', '20.67893281', '1620369217.253387'], ['363.91000', '20.67410886', '1620369218.409513'], ['363.95000', '149.98298942', '1620369218.135079'], ['363.96000', '162.80250000', '1620369215.092508', 'r'], ['364.03000', '16.60827279', '1620369215.390187', 'r'], ['364.15000', '0.45595970', '1620367748.020778', 'r'], ['364.17000', '0.20000000', '1620369196.146954', 'r'], ['364.23000', '169.69266000', '1620369211.647579', 'r'], ['364.27000', '283.47560000', '1620369217.419576', 'r'], ['364.30000', '298.59180000', '1620369218.384822'], ['364.35000', '47.30000000', '1620369215.619000', 'r'], ['364.45000', '0.22961154', '1620367606.218649', 'r']
        ])
        assert.equal(calculateChecksum(listener.orderBook!), "2724778063")
    })
    test('Calculate checksum', function() {
        const orderBook: KrakenOrderBook = {"as":[["333.28000","22.18700000","1620284872.527816"],["333.53000","20.27750240","1620284873.002472"],["333.57000","14.99962933","1620284872.933507"],["333.63000","15.68285520","1620284874.143294"],["333.64000","20.27117202","1620284871.887176"],["333.66000","22.49944400","1620284872.933616"],["333.67000","30.01925910","1620284873.771330"],["333.69000","0.25750000","1620284873.776441"],["333.72000","33.72099100","1620284872.751508"],["333.73000","20.26552249","1620284873.025918"],["333.81000","6.26359377","1620284873.347849"],["333.82000","40.41847403","1620284873.310407"],["333.83000","24.75070770","1620284874.091020"],["333.84000","30.00475596","1620284872.933936"],["333.94000","49.53000000","1620284865.858739"],["333.99000","20.24950020","1620284873.886401"],["334.02000","20.42425003","1620284872.753006"],["334.03000","4.54906240","1620284874.096533"],["334.04000","4.08583524","1620284873.907526"],["334.05000","11.05100000","1620284872.889631"],["334.06000","154.17510000","1620284872.767061"],["334.11000","272.92330000","1620284865.235444"],["334.13000","4.52435150","1620284873.475262"],["334.17000","0.05301077","1620284866.138541"],["334.29000","147.24917436","1620284871.191821","r"]],"bs":[["333.16000","12.00000000","1620284874.149722"],["333.15000","9.80000000","1620284874.026967"],["333.14000","81.99839193","1620284874.034896"],["333.13000","22.49689665","1620284873.892465"],["333.10000","14.84000000","1620284874.062966"],["333.06000","20.00000000","1620284873.822310"],["333.04000","22.49944466","1620284873.892682"],["333.02000","15.68674277","1620284873.355159"],["333.01000","22.50935606","1620284873.892588"],["332.99000","22.50285254","1620284873.354852"],["332.95000","10.59500000","1620284872.977616"],["332.92000","40.00000000","1620284873.788412"],["332.91000","52.51502222","1620284874.142341"],["332.86000","0.24750000","1620284873.176887"],["332.82000","22.52188906","1620284871.888349"],["332.81000","19.05814023","1620284873.354968"],["332.80000","292.86960000","1620284873.267427"],["332.77000","13.21850000","1620284870.830558"],["332.72000","7.87900516","1620284873.205283"],["332.71000","425.57000000","1620284873.169965"],["332.67000","30.01098739","1620284872.934103"],["332.66000","4.51046100","1620284873.704069"],["332.64000","18.38400000","1620284872.842821"],["332.63000","3.13169054","1620284873.441123"],["332.54000","1.66487310","1620284872.888197","r"]]}
        assert.equal(calculateChecksum(orderBook), "2689197497")
    })
    test('Stringify single value', () => {
        assert.equal(stringifySingleEntry([
            "321.61000",
            "5.47500000",
            "1620877029.047487"
         ]), '32161000547500000')
        assert.equal(stringifySingleEntry([
            "321.62000",
            "89.24998612",
            "1620877029.057821"
         ]), '321620008924998612')
        assert.equal(stringifySingleEntry([
            "321.72000",
            "47.86155337",
             "1620877029.127168"
        ]), '321720004786155337')
        assert.equal(stringifySingleEntry([
            "0.0072000",
            "47.86155337",
             "1620877029.127168"
        ]), '720004786155337')
    })

    test('Stringify order book', () => {
        assert.equal(stringifyOrderbook({
            "as":[
               [
                  "321.61000",
                  "5.47500000",
                  "1620877029.047487"
               ],
               [
                  "321.62000",
                  "89.24998612",
                  "1620877029.057821"
               ],
               [
                  "321.63000",
                  "201.48401186",
                  "1620877029.126471"
               ],
               [
                  "321.64000",
                  "40.00000000",
                  "1620877028.956035"
               ],
               [
                  "321.65000",
                  "11.00000000",
                  "1620877025.506216"
               ],
               [
                  "321.66000",
                  "23.31432836",
                  "1620877025.390641"
               ],
               [
                  "321.69000",
                  "12.60400000",
                  "1620877029.124338"
               ],
               [
                  "321.72000",
                  "31.10115305",
                  "1620877028.296132"
               ],
               [
                  "321.77000",
                  "3.24573803",
                  "1620877025.463359"
               ],
               [
                  "321.79000",
                  "15.26690000",
                  "1620877029.091206"
               ],
               [
                  "321.82000",
                  "28.21983602",
                  "1620877028.315611"
               ],
               [
                  "321.83000",
                  "9.10400000",
                  "1620877025.118765"
               ],
               [
                  "321.90000",
                  "129.63600000",
                  "1620877028.209806"
               ],
               [
                  "321.94000",
                  "4.63828650",
                  "1620877028.851317"
               ],
               [
                  "321.97000",
                  "268.39870000",
                  "1620877027.386805"
               ],
               [
                  "322.07000",
                  "3.30008222",
                  "1620877028.165112"
               ],
               [
                  "322.08000",
                  "4.60134120",
                  "1620877027.299415"
               ],
               [
                  "322.12000",
                  "260.43240000",
                  "1620877024.982048"
               ],
               [
                  "322.17000",
                  "6.48736893",
                  "1620877020.987719",
                  "r"
               ],
               [
                  "322.28000",
                  "0.16437854",
                  "1620877027.831430",
                  "r"
               ],
               [
                  "322.33000",
                  "9.56315746",
                  "1620877026.718731",
                  "r"
               ],
               [
                  "322.46000",
                  "10.17800000",
                  "1620877024.993122",
                  "r"
               ],
               [
                  "322.58000",
                  "0.21803418",
                  "1620877025.448947",
                  "r"
               ],
               [
                  "322.76000",
                  "50.00000000",
                  "1620876996.624473",
                  "r"
               ],
               [
                  "322.88000",
                  "152.44007126",
                  "1620877025.394925",
                  "r"
               ]
            ],
            "bs":[
               [
                  "321.62000",
                  "0.00001388",
                  "1620877027.931714"
               ],
               [
                  "321.14000",
                  "10.89070400",
                  "1620877029.085340"
               ],
               [
                  "321.04000",
                  "16.07189633",
                  "1620877028.997237"
               ],
               [
                  "321.00000",
                  "4.67289720",
                  "1620877028.017941",
                  "r"
               ],
               [
                  "320.90000",
                  "31.10896467",
                  "1620877028.309809"
               ],
               [
                  "320.79000",
                  "31.11842102",
                  "1620877028.312783"
               ],
               [
                  "320.77000",
                  "216.60848895",
                  "1620877028.097956"
               ],
               [
                  "320.75000",
                  "444.96250000",
                  "1620877028.421022"
               ],
               [
                  "320.74000",
                  "6.49225421",
                  "1620877028.862389"
               ],
               [
                  "320.68000",
                  "0.21868830",
                  "1620877029.112570"
               ],
               [
                  "320.62000",
                  "49.56000000",
                  "1620877018.213760",
                  "r"
               ],
               [
                  "320.55000",
                  "0.24250000",
                  "1620877028.931914"
               ],
               [
                  "320.51000",
                  "24.36395736",
                  "1620877029.103098"
               ],
               [
                  "320.47000",
                  "18.34580000",
                  "1620877028.079714"
               ],
               [
                  "320.44000",
                  "0.04898644",
                  "1620876880.605803",
                  "r"
               ],
               [
                  "320.37000",
                  "0.08909498",
                  "1620877028.865326",
                  "r"
               ],
               [
                  "320.23000",
                  "266.26090000",
                  "1620877028.379933"
               ],
               [
                  "320.13000",
                  "146.75018273",
                  "1620877021.702444",
                  "r"
               ],
               [
                  "320.07000",
                  "131.64970000",
                  "1620877028.861392"
               ],
               [
                  "320.05000",
                  "0.74756464",
                  "1620876976.407239",
                  "r"
               ],
               [
                  "319.60000",
                  "162.38000000",
                  "1620877028.444555"
               ],
               [
                  "319.57000",
                  "170.60000000",
                  "1620877015.320147",
                  "r"
               ],
               [
                  "319.46000",
                  "0.06012003",
                  "1620876793.929474",
                  "r"
               ],
               [
                  "319.20000",
                  "2.00000000",
                  "1620876726.374380",
                  "r"
               ],
               [
                  "319.09000",
                  "0.47906387",
                  "1620876931.105198",
                  "r"
               ]
            ]
         } as unknown as KrakenOrderBook), '321610005475000003216200089249986123216300020148401186321640004000000000321650001100000000321660002331432836321690001260400000321720003110115305321770003245738033217900015266900003216200013883211400010890704003210400016071896333210000046728972032090000311089646732079000311184210232077000216608488953207500044496250000320740006492254213206800021868830')
    })
}
