from bittrade_kraken_orderbook.check import calculate_checksum
from bittrade_kraken_orderbook.check.stringify import stringify_single_entry
from bittrade_kraken_orderbook.models import Order, OrderBook
from tests.helpers import list_to_orders


def test_stringify():
    assert stringify_single_entry(Order(
        "321.72000",
        "47.86155337",
        "1620877029.127168"
    )) == '321720004786155337'
    assert stringify_single_entry(Order(
        "0.0072000",
        "47.86155337",
        "1620877029.127168"
    )) == '720004786155337'
    assert stringify_single_entry(Order(
        "321.61000",
        "5.47500000",
        "1620877029.047487"
    )) == '32161000547500000'


def test_calculate_checksum():
    order_book = OrderBook(
        asks=list_to_orders([
            ["0.05005", "0.00000500", "1582905487.684110"],
            ["0.05010", "0.00000500", "1582905486.187983"],
            ["0.05015", "0.00000500", "1582905484.480241"],
            ["0.05020", "0.00000500", "1582905486.645658"],
            ["0.05025", "0.00000500", "1582905486.859009"],
            ["0.05030", "0.00000500", "1582905488.601486"],
            ["0.05035", "0.00000500", "1582905488.357312"],
            ["0.05040", "0.00000500", "1582905488.785484"],
            ["0.05045", "0.00000500", "1582905485.302661"],
            ["0.05050", "0.00000500", "1582905486.157467"],
            ["0.05050", "0.00000500", "1582905486.157467"]
        ]),
        bids=list_to_orders([
            ["0.05000", "0.00000500", "1582905487.439814"],
            ["0.04995", "0.00000500", "1582905485.119396"],
            ["0.04990", "0.00000500", "1582905486.432052"],
            ["0.04980", "0.00000500", "1582905480.609351"],
            ["0.04975", "0.00000500", "1582905476.793880"],
            ["0.04970", "0.00000500", "1582905486.767461"],
            ["0.04965", "0.00000500", "1582905481.767528"],
            ["0.04960", "0.00000500", "1582905487.378907"],
            ["0.04955", "0.00000500", "1582905483.626664"],
            ["0.04950", "0.00000500", "1582905488.509872"]
        ])
    )
    assert calculate_checksum(order_book) == "974947235", "First case"

    order_book = OrderBook(
        asks=list_to_orders(
            [["333.28000", "22.18700000", "1620284872.527816"], ["333.53000", "20.27750240", "1620284873.002472"],
             ["333.57000", "14.99962933", "1620284872.933507"], ["333.63000", "15.68285520", "1620284874.143294"],
             ["333.64000", "20.27117202", "1620284871.887176"], ["333.66000", "22.49944400", "1620284872.933616"],
             ["333.67000", "30.01925910", "1620284873.771330"], ["333.69000", "0.25750000", "1620284873.776441"],
             ["333.72000", "33.72099100", "1620284872.751508"], ["333.73000", "20.26552249", "1620284873.025918"],
             ["333.81000", "6.26359377", "1620284873.347849"], ["333.82000", "40.41847403", "1620284873.310407"],
             ["333.83000", "24.75070770", "1620284874.091020"], ["333.84000", "30.00475596", "1620284872.933936"],
             ["333.94000", "49.53000000", "1620284865.858739"], ["333.99000", "20.24950020", "1620284873.886401"],
             ["334.02000", "20.42425003", "1620284872.753006"], ["334.03000", "4.54906240", "1620284874.096533"],
             ["334.04000", "4.08583524", "1620284873.907526"], ["334.05000", "11.05100000", "1620284872.889631"],
             ["334.06000", "154.17510000", "1620284872.767061"], ["334.11000", "272.92330000", "1620284865.235444"],
             ["334.13000", "4.52435150", "1620284873.475262"], ["334.17000", "0.05301077", "1620284866.138541"],
             ["334.29000", "147.24917436", "1620284871.191821"]]),
        bids=list_to_orders(
            [["333.16000", "12.00000000", "1620284874.149722"], ["333.15000", "9.80000000", "1620284874.026967"],
             ["333.14000", "81.99839193", "1620284874.034896"], ["333.13000", "22.49689665", "1620284873.892465"],
             ["333.10000", "14.84000000", "1620284874.062966"], ["333.06000", "20.00000000", "1620284873.822310"],
             ["333.04000", "22.49944466", "1620284873.892682"], ["333.02000", "15.68674277", "1620284873.355159"],
             ["333.01000", "22.50935606", "1620284873.892588"], ["332.99000", "22.50285254", "1620284873.354852"],
             ["332.95000", "10.59500000", "1620284872.977616"], ["332.92000", "40.00000000", "1620284873.788412"],
             ["332.91000", "52.51502222", "1620284874.142341"], ["332.86000", "0.24750000", "1620284873.176887"],
             ["332.82000", "22.52188906", "1620284871.888349"], ["332.81000", "19.05814023", "1620284873.354968"],
             ["332.80000", "292.86960000", "1620284873.267427"], ["332.77000", "13.21850000", "1620284870.830558"],
             ["332.72000", "7.87900516", "1620284873.205283"], ["332.71000", "425.57000000", "1620284873.169965"],
             ["332.67000", "30.01098739", "1620284872.934103"], ["332.66000", "4.51046100", "1620284873.704069"],
             ["332.64000", "18.38400000", "1620284872.842821"], ["332.63000", "3.13169054", "1620284873.441123"],
             ["332.54000", "1.66487310", "1620284872.888197"]])
    )
    assert calculate_checksum(order_book) == "2689197497", "Second case"
